# PRD 02: Match-3 Puzzle - "Diamond Blast Factory"

## Reference Games

### Candy Crush Saga
- **Screenshot:** https://play-lh.googleusercontent.com/soHkdKxDdAyEfRSLu3oVLCLXMFxtbGh1-OvSUjSBE8hC2Vv7-SqnQz2KjhCDGS5T1A=w2560-h1440
- **Developer:** King
- **Core Mechanic:** Swap adjacent candies to create matches of 3+ identical items, clear objectives within move limit

### Bejeweled
- **Screenshot:** https://play-lh.googleusercontent.com/7sGfzEZ1KRMQKJn0PrFYhYXZqQJZ4Zp5X5u5Zm8u5u5u5u5u5u5u5u5u5u5u5u5u5u5=w2560-h1440
- **Developer:** PopCap Games / EA
- **Core Mechanic:** Swap gems to make horizontal/vertical matches of 3+, cascading combos create special gems

### Homescapes / Gardenscapes
- **Screenshot:** https://play-lh.googleusercontent.com/DIbn3fqJi4vxz2c8bYtD7qLbkJHKbHF7qLbkJHKbHF7qLbkJHKbHF7qLbkJHKbHF=w2560-h1440
- **Developer:** Playrix
- **Core Mechanic:** Match-3 with meta-game of rebuilding/decorating spaces using earned stars

## Core Mechanics

### Primary Action
- **Match Creation:** Swap two adjacent items to create lines of 3+ identical items
- **Valid Swaps:** Only swaps that create immediate matches are allowed
- **Match Types:**
  - 3-match: Basic clear (horizontal or vertical line)
  - 4-match: Special power gem (line-clearing ability)
  - 5-match (L/T shape): Area-effect explosion gem
  - 5-match (straight): Color-clearing wildcard gem

### Win/Fail Conditions
- **Win Conditions (varies by level):**
  - Clear X number of specific item types
  - Reach target score
  - Drop items to bottom of board (ingredient levels)
  - Clear obstacles (locked tiles, ice blocks, etc.)
  - Complete objective within move/time limit
  
- **Fail Conditions:**
  - Exhaust all available moves without completing objective
  - Run out of time (in timed levels)
  - No valid moves available (triggers board shuffle)

### Progression System
- **Level Progression:** 500+ levels with increasing difficulty
- **Star System:** Earn 1-3 stars based on score thresholds
- **Lives System:** 5 hearts, regenerate 1 every 30 minutes
- **Boosters:** Pre-level and in-level power-ups (earned or purchased)
- **Episode Unlock:** Complete levels to unlock new factory zones
- **Meta-Game:** Spend stars to upgrade factory equipment and unlock new production lines

## DMI Theme Concept

### Title: **"Diamond Blast Factory"**

### Tagline
*"Match the bits. Blast the quota. Build the best blade factory in the business!"*

### Player Role
**Production Manager** at DMI's diamond tool manufacturing plant. Your job is to sort and match diamond core bits, segments, and blades on the assembly line to meet daily production quotas and upgrade the factory.

### Story Hook
DMI Tools Corp just acquired an old, rundown blade manufacturing facility. As the new production manager, you need to sort incoming diamond bits and segments on the assembly line, meet customer orders, and earn stars to upgrade machinery, hire skilled workers, and expand production capacity. Each level represents a production shift where you must match and clear specific diamond tool components to fulfill orders before the deadline.

### Collectibles & Match Items

#### Diamond Core Bits (6 colors/types)
Each represents a different diamond grit size or application:
1. **Blue Bits** - Concrete (general purpose)
2. **Red Bits** - Hard Aggregate (premium)
3. **Green Bits** - Asphalt (softer materials)
4. **Yellow Bits** - Masonry (medium duty)
5. **Purple Bits** - Tile & Stone (specialty)
6. **Orange Bits** - Reinforced Concrete (heavy duty)

**Visual:** Circular saw blade segments with sparkling diamond edges, each color-coded

#### Special Items (Created by matches)

**Blade Launcher** (4-match horizontal/vertical)
- **Visual:** Full diamond blade spinning in place
- **Effect:** Clears entire row or column when matched
- **Factory Theme:** Launches blades down the production line

**Diamond Bomb** (5-match L/T shape)
- **Visual:** Cluster of diamond bits with fuse
- **Effect:** 3x3 area explosion, clears all items in radius
- **Factory Theme:** Quality control explosive test

**Rainbow Core** (5-match straight line)
- **Visual:** Iridescent diamond core bit with all colors
- **Effect:** Swap with any color to clear all of that type from board
- **Factory Theme:** Universal fitting master core

**Mega Blade** (Combine two special items)
- **Visual:** Large industrial blade with lightning effects
- **Effect:** Clears multiple rows/columns or entire board sections
- **Factory Theme:** Heavy-duty industrial cutting wheel

### Obstacles & Blockers

#### Assembly Line Challenges

**Cardboard Boxes** (1-3 layers)
- Contain diamond bits, must be matched adjacent to open
- Each match removes one layer
- Visual: Brown corrugated boxes with DMI logo

**Steel Crates** (locked)
- Require key matches (collect key items by matching near them)
- Block movement until unlocked
- Visual: Metal shipping containers

**Concrete Blocks**
- Cannot be moved or swapped
- Must be cleared by matching adjacent items or special powers
- 2-3 hits to destroy
- Visual: Gray concrete chunks with cracks

**Rebar Cages**
- Trap diamond bits inside, requires matching the trapped bit type
- Visual: Metal grid cage around gems

**Oil Spills**
- Spreads to adjacent tiles each turn if not cleared
- Cleared by matching on or adjacent to oil
- Visual: Black puddles with rainbow sheen

**Conveyor Belts**
- Items shift one space in direction of belt each move
- Creates dynamic puzzle element
- Visual: Animated belt texture with arrows

**Ice Blocks** (frozen bits)
- Diamond bits frozen in ice, cannot be swapped
- Thaw by matching adjacent, then bit becomes usable
- Visual: Blue-white ice with bit visible inside

**Grinder Wheels**
- Rotates position each turn, blocks matches
- Must be cleared with special powers
- Visual: Spinning abrasive grinding wheel

### Level Types

#### Order Fulfillment (most common)
- "Clear 30 Blue Bits and 20 Red Bits in 25 moves"
- Match and collect specific quantities of diamond bit types

#### Production Quota
- "Reach 50,000 points in 30 moves"
- Score-focused with emphasis on combos and special items

#### Quality Control
- "Clear all concrete blocks in 20 moves"
- Remove all obstacle types from board

#### Assembly Drop
- "Drop 5 diamond blades to bottom in 35 moves"
- Special items spawn at top, must navigate to bottom through obstacles

#### Timed Rush
- "Clear 40 bits in 60 seconds"
- Fast-paced time pressure instead of move limit

#### Boss Levels (every 20 levels)
- "Complete mega-order: 50 of each bit type in 40 moves"
- Unlock new factory zone upon completion

### Power-Ups & Boosters

#### Pre-Level Boosters (selected before starting)

**Forklift Start**
- Begin level with 3 random special items on board
- Cost: 100 coins

**Extra Moves**
- Start with +5 additional moves
- Cost: 150 coins

**Blueprint Planning**
- Highlight best move for 5 turns
- Cost: 200 coins

#### In-Level Boosters (tap to activate)

**Hammer** (earned or purchased)
- Tap to destroy any single item or 1 layer of obstacle
- Visual: DMI-branded safety hammer

**Blade Swap** (earned or purchased)
- Swap any two adjacent items (even if no match)
- Visual: Rotating blade exchange icon

**Mixer** (earned or purchased)
- Shuffle entire board to create new opportunities
- Visual: Concrete mixer rotating

**Foreman's Eye** (earned or purchased)
- Shows optimal move for next 3 turns
- Visual: Hard hat with magnifying glass

### Meta-Game: Factory Upgrade System

#### Areas to Upgrade (spend stars to unlock/improve)

**Production Floor**
- Conveyor Belt System (Level 1-5): Better production rates
- Assembly Stations (Level 1-5): Unlock new level types
- Quality Control Lab (Level 1-5): Better special item spawn rates

**Storage Warehouse**
- Shipping Dock (Level 1-5): More daily bonuses
- Inventory Racks (Level 1-5): Increase coin capacity
- Forklift Fleet (Level 1-5): Extra booster drops

**Office Building**
- Manager's Office (Level 1-5): Unlock new game modes
- Break Room (Level 1-5): Lives regenerate faster
- Conference Room (Level 1-5): Daily challenges unlocked

**Outdoor Yard**
- Loading Bay (Level 1-5): Bigger level rewards
- Tool Storage (Level 1-5): More power-up variety
- Parking Lot (Level 1-5): Cosmetic upgrades

Each upgrade costs 1-5 stars and provides tangible gameplay benefits or unlocks new content.

## Visual Style Recommendations

### Art Direction
- **Style:** Colorful, polished 2D with subtle 3D depth (isometric board angle)
- **Palette:**
  - Background: Industrial grays, steel blues, concrete beige
  - Bits: Vibrant jewel tones (blue, red, green, yellow, purple, orange)
  - UI: DMI Blue (#003DA5), Safety Yellow (#FFD700), clean whites
- **Lighting:** Overhead factory lighting with subtle shadows on board

### Board Design
- **Grid:** 8x8 or 9x9 cells depending on level
- **Tile Style:** Metallic checkered factory floor pattern
- **Depth:** Slight isometric tilt (10-15 degrees) for visual interest
- **Borders:** Industrial steel frame around play area

### Animation Style
- **Gem Movement:** Smooth tweens (200-300ms), easing for polish
- **Matches:** 
  - Sparkle particle burst
  - Score numbers pop up (+100, +500)
  - Matched items zoom into collection counter
- **Special Activations:**
  - Screen shake on explosions
  - Radial particle effects
  - Sound + visual feedback (satisfying!)
- **Cascades:** Items drop with slight bounce, delay creates anticipation

### UI Elements
- **Top Bar:**
  - Level objective (icon + counter)
  - Moves/Time remaining (large, clear)
  - Current score with star thresholds
- **Side Panel:**
  - Booster buttons (bottom-left)
  - Pause/settings (top-right)
- **Meta-Game:**
  - Isometric factory map with zones
  - Upgrade menu with before/after renders
  - Progress bars for collections

### Particle Effects
- **Diamond Sparkle:** Continuous subtle shimmer on all bits
- **Match Burst:** Color-coded explosion particles
- **Special Activation:** Electric arcs, spinning blades, shockwaves
- **Combo Feedback:** "GREAT!" "AMAZING!" "SUPER!" text with scaling animation

## Technical Specifications (Phaser 3)

### Scene Architecture
```javascript
class GameBoardScene extends Phaser.Scene {
  create() {
    this.board = new Board(8, 8); // Grid system
    this.inputManager = new SwapInputManager();
    this.matchDetector = new MatchDetector();
    this.levelGoals = new LevelGoals(levelData);
    this.initializeBoard();
  }
  
  update() {
    // Handle animations, check for game over/win
    if (this.levelGoals.isComplete()) this.handleLevelWin();
    if (this.movesRemaining <= 0) this.handleLevelLose();
  }
}
```

### Key Systems

#### 1. Board Grid System
```javascript
class Board {
  constructor(rows, cols) {
    this.rows = rows;
    this.cols = cols;
    this.grid = this.createEmptyGrid();
    this.tileSize = 70; // pixels
  }
  
  createEmptyGrid() {
    return Array(this.rows).fill(null)
      .map(() => Array(this.cols).fill(null));
  }
  
  getTile(row, col) {
    return this.grid[row][col];
  }
  
  setTile(row, col, gem) {
    this.grid[row][col] = gem;
  }
  
  swapTiles(pos1, pos2) {
    const temp = this.getTile(pos1.row, pos1.col);
    this.setTile(pos1.row, pos1.col, this.getTile(pos2.row, pos2.col));
    this.setTile(pos2.row, pos2.col, temp);
  }
}
```

#### 2. Match Detection Algorithm
```javascript
class MatchDetector {
  findMatches(board) {
    const matches = [];
    
    // Check horizontal matches
    for (let row = 0; row < board.rows; row++) {
      let matchLength = 1;
      for (let col = 1; col < board.cols; col++) {
        if (board.getTile(row, col).type === board.getTile(row, col - 1).type) {
          matchLength++;
        } else {
          if (matchLength >= 3) {
            matches.push({ row, startCol: col - matchLength, length: matchLength, direction: 'horizontal' });
          }
          matchLength = 1;
        }
      }
      if (matchLength >= 3) {
        matches.push({ row, startCol: board.cols - matchLength, length: matchLength, direction: 'horizontal' });
      }
    }
    
    // Check vertical matches (similar logic)
    // ...
    
    return matches;
  }
  
  detectSpecialGems(matches) {
    matches.forEach(match => {
      if (match.length === 4) return 'lineClearer';
      if (match.length === 5) return 'colorBomb';
      if (this.isLShape(match) || this.isTShape(match)) return 'bomb';
    });
  }
}
```

#### 3. Swap & Validation
```javascript
class SwapInputManager {
  handleInput(gem1, gem2, board) {
    // Validate adjacency
    if (!this.areAdjacent(gem1.pos, gem2.pos)) return false;
    
    // Perform temporary swap
    board.swapTiles(gem1.pos, gem2.pos);
    
    // Check if swap creates matches
    const matches = matchDetector.findMatches(board);
    
    if (matches.length > 0) {
      // Valid swap - proceed with animations
      this.animateSwap(gem1, gem2);
      this.processMatches(matches);
      this.decrementMoves();
      return true;
    } else {
      // Invalid swap - animate rejection
      board.swapTiles(gem1.pos, gem2.pos); // Swap back
      this.animateReject(gem1, gem2);
      return false;
    }
  }
  
  areAdjacent(pos1, pos2) {
    const rowDiff = Math.abs(pos1.row - pos2.row);
    const colDiff = Math.abs(pos1.col - pos2.col);
    return (rowDiff === 1 && colDiff === 0) || (rowDiff === 0 && colDiff === 1);
  }
}
```

#### 4. Cascade & Refill System
```javascript
class CascadeManager {
  async processCascade(board, matches) {
    // 1. Remove matched gems
    this.clearMatches(matches);
    
    // 2. Drop existing gems to fill gaps
    await this.dropGems(board);
    
    // 3. Spawn new gems at top
    await this.spawnNewGems(board);
    
    // 4. Check for new matches (recursive)
    const newMatches = matchDetector.findMatches(board);
    if (newMatches.length > 0) {
      this.comboMultiplier++;
      await this.processCascade(board, newMatches); // Recursive!
    } else {
      this.comboMultiplier = 1;
    }
  }
  
  async dropGems(board) {
    const promises = [];
    
    for (let col = 0; col < board.cols; col++) {
      let emptySpaces = 0;
      
      for (let row = board.rows - 1; row >= 0; row--) {
        if (board.getTile(row, col) === null) {
          emptySpaces++;
        } else if (emptySpaces > 0) {
          // Move gem down
          const gem = board.getTile(row, col);
          board.setTile(row + emptySpaces, col, gem);
          board.setTile(row, col, null);
          
          // Animate drop
          promises.push(this.animateDrop(gem, emptySpaces));
        }
      }
    }
    
    await Promise.all(promises);
  }
  
  async spawnNewGems(board) {
    const promises = [];
    
    for (let col = 0; col < board.cols; col++) {
      for (let row = 0; row < board.rows; row++) {
        if (board.getTile(row, col) === null) {
          const newGem = this.createRandomGem(row, col);
          board.setTile(row, col, newGem);
          promises.push(this.animateSpawn(newGem));
        }
      }
    }
    
    await Promise.all(promises);
  }
}
```

#### 5. Special Gem Activation
```javascript
class SpecialGemHandler {
  activateBladeLauncher(gem, board) {
    const { row, col } = gem.pos;
    
    if (gem.direction === 'horizontal') {
      // Clear entire row
      for (let c = 0; c < board.cols; c++) {
        this.clearGem(board.getTile(row, c));
      }
      this.animateRowClear(row);
    } else {
      // Clear entire column
      for (let r = 0; r < board.rows; r++) {
        this.clearGem(board.getTile(r, col));
      }
      this.animateColumnClear(col);
    }
  }
  
  activateDiamondBomb(gem, board) {
    const { row, col } = gem.pos;
    
    // Clear 3x3 area
    for (let r = row - 1; r <= row + 1; r++) {
      for (let c = col - 1; c <= col + 1; c++) {
        if (r >= 0 && r < board.rows && c >= 0 && c < board.cols) {
          this.clearGem(board.getTile(r, c));
        }
      }
    }
    
    this.animateExplosion(gem.pos, 3);
  }
  
  activateRainbowCore(gem, targetColor, board) {
    // Clear all gems of target color
    for (let r = 0; r < board.rows; r++) {
      for (let c = 0; c < board.cols; c++) {
        if (board.getTile(r, c).type === targetColor) {
          this.clearGem(board.getTile(r, c));
        }
      }
    }
    
    this.animateColorClear(targetColor);
  }
}
```

#### 6. Level Goal System
```javascript
class LevelGoals {
  constructor(levelData) {
    this.objectives = levelData.objectives; // e.g., { blueBits: 30, redBits: 20 }
    this.movesLimit = levelData.moves;
    this.starThresholds = levelData.stars; // [10000, 20000, 30000]
    this.currentProgress = {};
  }
  
  updateProgress(matchedGems) {
    matchedGems.forEach(gem => {
      if (this.objectives[gem.type]) {
        this.currentProgress[gem.type] = (this.currentProgress[gem.type] || 0) + 1;
      }
    });
    
    this.checkCompletion();
  }
  
  isComplete() {
    return Object.keys(this.objectives).every(key => {
      return this.currentProgress[key] >= this.objectives[key];
    });
  }
  
  getStarsEarned(finalScore) {
    if (finalScore >= this.starThresholds[2]) return 3;
    if (finalScore >= this.starThresholds[1]) return 2;
    if (finalScore >= this.starThresholds[0]) return 1;
    return 0;
  }
}
```

### Asset Requirements

#### Spritesheets
- **Diamond Bits:** 6 color variants (blue, red, green, yellow, purple, orange)
  - Idle state with subtle shimmer animation (4 frames)
  - Matched state with burst effect (8 frames)
  
- **Special Gems:**
  - Blade Launcher (horizontal/vertical variants, spinning animation)
  - Diamond Bomb (pulsing glow effect)
  - Rainbow Core (color-shifting animation)
  
- **Obstacles:**
  - Cardboard boxes (1-3 layer states)
  - Steel crates (locked/unlocked)
  - Concrete blocks (cracked states)
  - Rebar cages
  - Oil spills (spreading animation)
  - Conveyor belts (animated texture)
  - Ice blocks (thawing animation)

#### UI Graphics
- **Buttons:** Play, pause, restart, boosters (hammer, swap, mixer, eye)
- **Bars:** Progress bars, star thresholds, move counter
- **Icons:** Level objectives, currencies (coins, stars)
- **Popups:** Level start, level complete, level failed, upgrade menus

#### Particle Effects
- Match burst (color-matched particles)
- Special activation (lightning, shockwave, sparkles)
- Combo text ("GREAT!", "AMAZING!", etc.)
- Star collection animation

#### Audio
- **SFX:**
  - Gem select (subtle click)
  - Swap sound (whoosh)
  - Match clear (satisfying "pop" with pitch variation)
  - Special activation (explosion, blade spin, color clear)
  - Cascade combo (ascending pitch sequence)
  - Victory fanfare
  - Failure sound
  
- **Music:**
  - Upbeat factory-themed background track
  - Intensity increases with combo multiplier
  - Victory jingle
  - Meta-game/upgrade menu music (calmer)

### Performance Optimization

- **Object Pooling:** Reuse gem sprites instead of destroy/create
- **Texture Atlas:** Combine all gem sprites into single atlas
- **Particle Limits:** Max 200 particles on screen, cull oldest first
- **Animation Queue:** Sequence animations to prevent overwhelming mobile devices
- **Board Size:** Limit to 9x9 max for performance
- **Save State:** LocalStorage for progress, sync to backend on connection

### Mobile Considerations
- **Touch Targets:** Minimum 60x60px tap area
- **Swipe Detection:** Support both tap-tap and drag gestures
- **Responsive Layout:** Scale board to fit screen while maintaining aspect ratio
- **Battery:** Pause game when app backgrounded, reduce particle effects on low-end devices

## PRD Summary

**Diamond Blast Factory** brings the proven match-3 puzzle formula into DMI's world of diamond tool manufacturing. Players step into the role of a production manager at a newly acquired blade factory, matching diamond core bits on the assembly line to fulfill customer orders and earn stars for factory upgrades. The game successfully translates the addictive core loop of Candy Crush and Bejeweled into an industrial setting—swapping colorful diamond bits instead of candy, clearing concrete blocks and rebar obstacles instead of generic blockers, and activating special "Blade Launchers" and "Diamond Bombs" instead of striped candies and color bombs.

The dual-layer progression system keeps players engaged long-term: the puzzle gameplay provides immediate satisfaction with each level completion, while the meta-game of upgrading the factory (production floors, warehouses, offices, outdoor yards) creates a compelling sense of ownership and long-term investment. Each star earned unlocks tangible gameplay improvements—faster lives regeneration, better special item spawn rates, new level types—giving real value to mastery. The six color-coded diamond bit types (blue for concrete, red for hard aggregate, etc.) educate players about DMI's product line while maintaining the accessibility of traditional match-3 color schemes.

Technically, Phaser 3's sprite management and animation capabilities make it ideal for implementing the complex cascade system, special gem interactions, and particle effects that make match-3 games feel polished and satisfying. The modular level system allows for easy content creation—designers can quickly build 500+ levels with varying objectives, obstacles, and difficulty curves using a JSON-based level editor. Monetization follows industry standards: lives system with regeneration timers, optional booster purchases, and cosmetic factory customizations. The game is designed as a PWA for cross-platform accessibility, with offline play and cloud save syncing. Diamond Blast Factory positions itself as both an engaging casual puzzle game and a subtle brand ambassador for DMI Tools Corp, turning every match into a moment of brand interaction.
